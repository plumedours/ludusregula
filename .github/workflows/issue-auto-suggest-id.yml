name: Suggest game id on issue
on:
  issues:
    types: [opened, edited]

permissions:
  contents: read
  issues: write

jobs:
  suggest-id:
    runs-on: ubuntu-latest
    steps:
      - name: Suggest kebab-case id
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || "";

            // Extract section content rendered by Issue Forms (### headings)
            function getSection(title) {
              const re = new RegExp(`### ${title}\\s+([\\s\\S]*?)(?=\\n### |$)`, "i");
              const m = body.match(re);
              let val = m ? (m[1] || "").trim() : "";
              // GitHub writes "No response" for empty fields â€” ignore it.
              val = val.replace(/^No response\s*$/i, "").trim();
              return val;
            }

            const name = getSection("Nom du jeu");
            const rawId = getSection("Identifiant \\(kebab-case\\)");

            const kebab = (s) =>
              s
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, "-")
                .replace(/^-+|-+$/g, "")
                .replace(/--+/g, "-");

            const isKebab = (v) => /^[a-z0-9]+(?:-[a-z0-9]+)*$/.test(v);

            if (!name) {
              core.info("No 'Nom du jeu'; skipping.");
              return;
            }
            if (rawId && isKebab(rawId)) {
              core.info("Valid id already provided; skipping.");
              return;
            }

            const suggestion = kebab(name);
            if (!suggestion) {
              core.info("No suggestion; skipping.");
              return;
            }

            const msg = [
              "Bonjour ! ðŸ‘‹ Merci pour votre proposition.",
              "",
              `Ã€ partir du **Nom du jeu** saisi (â€œ${name}â€), lâ€™identifiant *kebab-case* suggÃ©rÃ© est :`,
              "",
              "`" + suggestion + "`",
              "",
              "> Utilisez cet identifiant pour nommer vos fichiers :",
              `> - \`public/rules/${suggestion}.pdf\``,
              `> - \`public/thumbs/${suggestion}.webp\` (ou .jpg/.png)`
            ].join("\n");

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: msg
            });